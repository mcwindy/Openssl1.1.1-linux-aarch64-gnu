name: Build Openssl
on:
  push
jobs:
  aarch64_build_job:
    runs-on: ubuntu-22.04
    name: Build Openssl on ubuntu-22.04 aarch64
    steps:          
    - name: Run commands on aarch64
      uses: uraimo/run-on-arch-action@v2
      id: runcmd
      with:
        arch: aarch64
        distro: ubuntu22.04
        cache: true
        
        # Not required, but speeds up builds by storing container images in
        # a GitHub package registry.
        githubToken: ${{ github.token }}
        
        install: |
          apt update -q -y
          apt install -q -y g++ cmake ninja-build git perl
        run: |
          uname -a
          arch
          pwd
          nproc
          mkdir -p /usr/local/ssl/linux-aarch64/
          git clone -b OpenSSL_1_1_1-stable --single-branch --depth=1 --recurse-submodules -j4 https://github.com/openssl/openssl.git
          cd openssl
          ./Configure linux-aarch64 --openssldir=/usr/local/ssl/linux-aarch64/
          make -j$(nproc)
          ls /usr/local/ssl/linux-aarch64/
          pwd
          tar -czvf OpenSSL1.1.1_release_linux_aarch64.tar.gz /usr/local/ssl/linux-aarch64/
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ github.token }}"\
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/mcwindy/Openssl1.1.1-linux-aarch64-gnu/releases \
            -d '{"tag_name":"v1.1.1s","target_commitish":"main","draft":true,"prerelease":false}'
        
